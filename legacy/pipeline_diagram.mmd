graph TB
    subgraph data_prep["üìä Data Preparation"]
        direction TB
        tqa_raw["TruthfulQA Dataset<br/>(817 examples)"]
        split["Split into 4 sets"]
        tqa_split["steering: 100<br/>train: 250<br/>val: 117<br/>test: 200"]

        tqa_raw --> split
        split --> tqa_split
    end

    subgraph caa_extract["üß† CAA Vector Extraction"]
        direction TB
        caa_input["INPUT:<br/>‚Ä¢ Steering data (100 samples)<br/>‚Ä¢ Model at layer L"]
        caa_process["PROCESS:<br/>1. Forward pass with correct answer ‚Üí h‚Å∫ ‚àà ‚Ñù·µà<br/>2. Forward pass with incorrect answer ‚Üí h‚Åª ‚àà ‚Ñù·µà<br/>3. Compute: v = h‚Å∫ - h‚Åª ‚àà ‚Ñù·µà"]
        caa_output["OUTPUT:<br/>CAA vectors {v‚ÇÅ, v‚ÇÇ, ..., v‚ÇÅ‚ÇÄ‚ÇÄ} ‚àà ‚Ñù·µà"]

        caa_input --> caa_process
        caa_process --> caa_output
    end

    subgraph vector_bank["üóÑÔ∏è Vector Bank Creation"]
        direction TB
        vb_input["INPUT:<br/>CAA vectors {v‚ÇÅ, ..., v‚ÇÅ‚ÇÄ‚ÇÄ}"]
        vb_process["PROCESS:<br/>Sample random combinations:<br/>v‚Çú = Œ£·µ¢ Œ±·µ¢v·µ¢ where Œ£Œ±·µ¢ = 1"]
        vb_output["OUTPUT:<br/>Vector bank {v‚ÇÅ, ..., v‚Çú} ‚àà ‚Ñù·µà<br/>(T = 1000 vectors)"]

        vb_input --> vb_process
        vb_process --> vb_output
    end

    subgraph mlp_mc_training["üéØ MC MLP Training"]
        direction TB
        mlp_mc_input["INPUT:<br/>‚Ä¢ Vector bank {v‚ÇÅ, ..., v‚Çú}<br/>‚Ä¢ Train data (250 samples)<br/>‚Ä¢ Val data (117 samples)"]

        mlp_mc_arch["MC MLP Architecture:<br/>d ‚Üí 2d ‚Üí d"]

        mlp_mc_forward["For each MC sample:<br/>1. Sample vector v‚Çú<br/>2. Transform: v'‚Çú = MLP_MC(v‚Çú) ‚àà ‚Ñù·µà<br/>3. Apply steering at layer L<br/>4. Get logits for answer choices"]

        loss_mc["MC Loss:<br/>‚Ñí_MC = max(0, margin - logit(correct) + logit(incorrect))<br/>(hinge loss, skipped if not MC format)<br/>Optimize via Adam"]

        mlp_mc_output["OUTPUT:<br/>Trained MLP_MC: ‚Ñù·µà ‚Üí ‚Ñù·µà"]

        mlp_mc_input --> mlp_mc_arch
        mlp_mc_arch --> mlp_mc_forward
        mlp_mc_forward --> loss_mc
        loss_mc --> mlp_mc_output
    end

    subgraph mlp_gen_training["üéØ Generation MLP Training"]
        direction TB
        mlp_gen_input["INPUT:<br/>‚Ä¢ Vector bank {v‚ÇÅ, ..., v‚Çú}<br/>‚Ä¢ Train data (250 samples)<br/>‚Ä¢ Val data (117 samples)"]

        mlp_gen_arch["Generation MLP Architecture:<br/>d ‚Üí 2d ‚Üí d"]

        mlp_gen_forward["For each training sample:<br/>1. Sample vector v‚Çú<br/>2. Transform: v'‚Çú = MLP_Gen(v‚Çú) ‚àà ‚Ñù·µà<br/>3. Apply steering at layer L<br/>4. Generate answer tokens"]

        loss_gen["Generation Loss:<br/>‚Ñí_gen = -log P(y* | Q, v'‚Çú)<br/>(teacher forcing with gold answer y*)<br/>Optimize via Adam"]

        mlp_gen_output["OUTPUT:<br/>Trained MLP_Gen: ‚Ñù·µà ‚Üí ‚Ñù·µà"]

        mlp_gen_input --> mlp_gen_arch
        mlp_gen_arch --> mlp_gen_forward
        mlp_gen_forward --> loss_gen
        loss_gen --> mlp_gen_output
    end

    subgraph inference["üîÆ Inference"]
        direction TB
        inf_input["INPUT:<br/>‚Ä¢ Test data (200 samples)<br/>‚Ä¢ Trained MLP_Gen<br/>‚Ä¢ Vector bank"]
        inf_process["For each test sample:<br/>1. Sample steering vector v‚Çú<br/>2. Transform: v'‚Çú = MLP_Gen(v‚Çú)<br/>3. Apply steering at layer L<br/>4. Generate answer (greedy decode)"]
        inf_output["OUTPUT:<br/>Generated answers {≈∑‚ÇÅ, ..., ≈∑‚ÇÇ‚ÇÄ‚ÇÄ}"]

        inf_input --> inf_process
        inf_process --> inf_output
    end

    subgraph evaluation["üìà Evaluation"]
        direction TB
        eval_input["INPUT:<br/>‚Ä¢ Generated answers {≈∑}<br/>‚Ä¢ Gold answers {y*}<br/>‚Ä¢ Judge model"]

        eval_judge["Judge Model Scoring:<br/>For each (≈∑, y*):<br/>score ‚àà {0, 1}"]

        eval_metrics["Metrics:<br/>‚Ä¢ Accuracy = (1/N)Œ£·µ¢ score(≈∑·µ¢, y*·µ¢)<br/>‚Ä¢ Per-category accuracy"]

        eval_output["OUTPUT:<br/>Test accuracy, metrics, analysis"]

        eval_input --> eval_judge
        eval_judge --> eval_metrics
        eval_metrics --> eval_output
    end

    %% Main flow connections
    tqa_split --> caa_input
    caa_output --> vb_input
    vb_output --> mlp_mc_input
    vb_output --> mlp_gen_input
    mlp_gen_output --> inf_input
    inf_output --> eval_input

    %% Styling
    classDef inputStyle fill:#e1f5ff,stroke:#0288d1,stroke-width:2px
    classDef processStyle fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    classDef outputStyle fill:#e8f5e9,stroke:#388e3c,stroke-width:2px
    classDef lossStyle fill:#fce4ec,stroke:#c2185b,stroke-width:2px

    class caa_input,mlp_mc_input,mlp_gen_input,inf_input,eval_input,vb_input inputStyle
    class caa_process,mlp_mc_forward,mlp_gen_forward,inf_process,eval_judge,vb_process processStyle
    class caa_output,mlp_mc_output,mlp_gen_output,inf_output,eval_output,vb_output outputStyle
    class loss_mc,loss_gen lossStyle
